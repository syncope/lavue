

<!doctype html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>lavuelib.imageFileHandler &#8212; LaVue 2.83.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/bizstyle.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">LaVue 2.83.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">lavuelib.imageFileHandler</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for lavuelib.imageFileHandler</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (C) 2017  DESY, Christoph Rosemann, Notkestr. 85, D-22607 Hamburg</span>
<span class="c1">#</span>
<span class="c1"># lavue is an image viewing program for photon science imaging detectors.</span>
<span class="c1"># Its usual application is as a live viewer using hidra as data source.</span>
<span class="c1">#</span>
<span class="c1"># This program is free software; you can redistribute it and/or</span>
<span class="c1"># modify it under the terms of the GNU General Public License</span>
<span class="c1"># as published by the Free Software Foundation in  version 2</span>
<span class="c1"># of the License.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program; if not, write to the Free Software</span>
<span class="c1"># Foundation, Inc., 51 Franklin Street, Fifth Floor,</span>
<span class="c1"># Boston, MA  02110-1301, USA.</span>
<span class="c1">#</span>
<span class="c1"># Authors:</span>
<span class="c1">#     Christoph Rosemann &lt;christoph.rosemann@desy.de&gt;</span>
<span class="c1">#     Andre Rothkirch &lt;andre.rothkirch@desy.de&gt;</span>
<span class="c1">#     Jan Kotanski &lt;jan.kotanski@desy.de&gt;</span>
<span class="c1">#</span>

<span class="sd">&quot;&quot;&quot; this a simple file handler that loads image files</span>
<span class="sd">    and delivers just the actual array &quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">filewriter</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
    <span class="n">long</span> <span class="o">=</span> <span class="nb">int</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">fabio</span>
    <span class="c1">#: (:obj:`bool`) fabio can be imported</span>
    <span class="n">FABIO</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">FABIO</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">PIL</span>
    <span class="kn">import</span> <span class="nn">PIL.Image</span>
    <span class="c1">#: (:obj:`bool`) PIL can be imported</span>
    <span class="n">PILLOW</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">PILLOW</span> <span class="o">=</span> <span class="kc">False</span>


<span class="c1">#: (:obj:`dict` &lt;:obj:`str`, :obj:`module`&gt; ) nexus writer modules</span>
<span class="n">WRITERS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">h5pywriter</span>
    <span class="n">WRITERS</span><span class="p">[</span><span class="s2">&quot;h5py&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5pywriter</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">h5cppwriter</span>
    <span class="n">WRITERS</span><span class="p">[</span><span class="s2">&quot;h5cpp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5cppwriter</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;lavue&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="NexusFieldHandler"><a class="viewcode-back" href="../../develop/lavuelib/lavuelib.html#lavuelib.imageFileHandler.NexusFieldHandler">[docs]</a><span class="k">class</span> <span class="nc">NexusFieldHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Nexus file handler class.</span>
<span class="sd">       Reads image from file and returns the numpy array.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; constructor</span>

<span class="sd">        :param fname: file name</span>
<span class="sd">        :type fname: :obj:`str`</span>
<span class="sd">        :param writer: h5 writer module: &quot;h5cpp&quot; or &quot;h5py&quot;</span>
<span class="sd">        :type writer: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#: (:obj:`any`) module image object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__image</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#: (:obj:`numpy.ndarray`) image data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#: (:obj:`str`) file name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fname</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="c1">#: (:obj:`dict` &lt;:obj:`str`,  :obj:`dict` &lt;:obj:`str`, :obj:`any`&gt;&gt;)</span>
        <span class="c1">#: image field dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># (:class:`lavuelib.filewriter.root`) nexus file root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__root</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># (:class:`lavuelib.filewriter.FTFile&#39;) nexus file object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fl</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#: (:obj:`str`) json dictionary with metadata or empty string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">writer</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;h5cpp&quot;</span> <span class="ow">in</span> <span class="n">WRITERS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="s2">&quot;h5cpp&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="s2">&quot;h5py&quot;</span>
        <span class="k">if</span> <span class="n">writer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">WRITERS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Writer &#39;</span><span class="si">%s</span><span class="s2">&#39; cannot be opened&quot;</span> <span class="o">%</span> <span class="n">writer</span><span class="p">)</span>
        <span class="n">wrmodule</span> <span class="o">=</span> <span class="n">WRITERS</span><span class="p">[</span><span class="n">writer</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">fname</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__fl</span> <span class="o">=</span> <span class="n">filewriter</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span>
                    <span class="n">fname</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="n">wrmodule</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">libver</span><span class="o">=</span><span class="s1">&#39;latest&#39;</span><span class="p">,</span>
                    <span class="n">swmr</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="k">if</span> <span class="n">writer</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;h5py&quot;</span><span class="p">,</span> <span class="s2">&quot;h5cpp&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">False</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__fl</span> <span class="o">=</span> <span class="n">filewriter</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span>
                        <span class="n">fname</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="n">wrmodule</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;File &#39;</span><span class="si">%s</span><span class="s2">&#39; cannot be opened </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">))</span>
                <span class="c1"># except Exception as e:</span>
                <span class="c1">#     raise Exception(&quot;File &#39;%s&#39; cannot be opened %s\n&quot;</span>
                <span class="c1">#                % (fname, str(e)))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fl</span><span class="o">.</span><span class="n">root</span><span class="p">()</span>

<div class="viewcode-block" id="NexusFieldHandler.frombuffer"><a class="viewcode-back" href="../../develop/lavuelib/lavuelib.html#lavuelib.imageFileHandler.NexusFieldHandler.frombuffer">[docs]</a>    <span class="k">def</span> <span class="nf">frombuffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">membuffer</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; constructor</span>

<span class="sd">        :param membuffer: memory buffer</span>
<span class="sd">        :type membuffer: :obj:`bytes` or :obj:`io.BytesIO`</span>
<span class="sd">        :param fname: file name</span>
<span class="sd">        :type fname: :obj:`str`</span>
<span class="sd">        :param writer: h5 writer module: &quot;h5py&quot; or &quot;h5py&quot;</span>
<span class="sd">        :type writer: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__fname</span> <span class="o">=</span> <span class="n">fname</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">writer</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;h5cpp&quot;</span> <span class="ow">in</span> <span class="n">WRITERS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> \
               <span class="n">WRITERS</span><span class="p">[</span><span class="s2">&quot;h5cpp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">is_image_file_supported</span><span class="p">():</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="s2">&quot;h5cpp&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;h5py&quot;</span> <span class="ow">in</span> <span class="n">WRITERS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> \
                 <span class="n">WRITERS</span><span class="p">[</span><span class="s2">&quot;h5py&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">is_image_file_supported</span><span class="p">():</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="s2">&quot;h5py&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;h5cpp&quot;</span> <span class="ow">in</span> <span class="n">WRITERS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="s2">&quot;h5cpp&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="s2">&quot;h5py&quot;</span>
        <span class="k">if</span> <span class="n">writer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">WRITERS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Writer &#39;</span><span class="si">%s</span><span class="s2">&#39; cannot be opened&quot;</span> <span class="o">%</span> <span class="n">writer</span><span class="p">)</span>
        <span class="n">wrmodule</span> <span class="o">=</span> <span class="n">WRITERS</span><span class="p">[</span><span class="n">writer</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__fl</span> <span class="o">=</span> <span class="n">filewriter</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span>
                <span class="n">membuffer</span><span class="p">,</span>
                <span class="n">fname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__fname</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="n">wrmodule</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">libver</span><span class="o">=</span><span class="s1">&#39;latest&#39;</span><span class="p">,</span>
                <span class="n">swmr</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="k">if</span> <span class="n">writer</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;h5py&quot;</span><span class="p">,</span> <span class="s2">&quot;h5cpp&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">False</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__fl</span> <span class="o">=</span> <span class="n">filewriter</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span>
                    <span class="n">membuffer</span><span class="p">,</span>
                    <span class="n">fname</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="n">wrmodule</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;File &#39;</span><span class="si">%s</span><span class="s2">&#39; cannot be loaded </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fname</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fl</span><span class="o">.</span><span class="n">root</span><span class="p">()</span></div>

<div class="viewcode-block" id="NexusFieldHandler.findImageFields"><a class="viewcode-back" href="../../develop/lavuelib/lavuelib.html#lavuelib.imageFileHandler.NexusFieldHandler.findImageFields">[docs]</a>    <span class="k">def</span> <span class="nf">findImageFields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; provides a dictionary with of all image fields</span>

<span class="sd">        :returns: dictionary of the field names and the field objects</span>
<span class="sd">        :rtype: :obj:`dict` &lt;:obj:`str`,  :obj:`dict` &lt;:obj:`str`, :obj:`any`&gt;&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#: (:obj:`dict` &lt;:obj:`str`,  :obj:`dict` &lt;:obj:`str`, :obj:`any`&gt;&gt;)</span>
        <span class="c1">#: image field dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__parseimages</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__root</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fields</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__getpath</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; converts full_path with NX_classes into nexus_path</span>

<span class="sd">        :param path: nexus full_path</span>
<span class="sd">        :type path: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">dr</span> <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dr</span> <span class="k">else</span> <span class="n">dr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
             <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="n">spath</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__addimage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">tgpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;adds the node into the description list</span>

<span class="sd">        :param node: nexus node</span>
<span class="sd">        :type node: :class:`lavuelib.filewriter.FTField` or \</span>
<span class="sd">                    :class:`lavuelib.filewriter.FTGroup`</span>
<span class="sd">        :param path: path of the link target or `None`</span>
<span class="sd">        :type path: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">filewriter</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">desc</span><span class="p">[</span><span class="s2">&quot;full_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">desc</span><span class="p">[</span><span class="s2">&quot;nexus_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__getpath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">):</span>
            <span class="n">desc</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">shape</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">desc</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">):</span>
            <span class="n">desc</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
            <span class="n">desc</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__fields</span><span class="p">[</span><span class="n">desc</span><span class="p">[</span><span class="s2">&quot;nexus_path&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">desc</span>

    <span class="k">def</span> <span class="nf">__parseimages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">tgpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;parses the node and add it into the description list</span>

<span class="sd">        :param node: nexus node</span>
<span class="sd">        :type node: :class:`lavuelib.filewriter.FTField` or \</span>
<span class="sd">                    :class:`lavuelib.filewriter.FTGroup` or</span>
<span class="sd">        :param path: path of the link target or `None`</span>
<span class="sd">        :type path: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__addimage</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">tgpath</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">filewriter</span><span class="o">.</span><span class="n">FTGroup</span><span class="p">):</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                 <span class="nb">str</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">target_path</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="s2">&quot;target_path&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">filewriter</span><span class="o">.</span><span class="n">get_links</span><span class="p">(</span><span class="n">node</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">nm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__parseimages</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">nm</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="c1">#            except Exception:</span>
<span class="c1">#                pass</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">pass</span>

<div class="viewcode-block" id="NexusFieldHandler.getNode"><a class="viewcode-back" href="../../develop/lavuelib/lavuelib.html#lavuelib.imageFileHandler.NexusFieldHandler.getNode">[docs]</a>    <span class="k">def</span> <span class="nf">getNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; get node</span>
<span class="sd">        :param field: field path</span>
<span class="sd">        :type field: :obj:`str`</span>
<span class="sd">        :returns: nexus field node</span>
<span class="sd">        :rtype: :class:`lavuelib.filewriter.FTField`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sfield</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__root</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">sfield</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fl</span><span class="o">.</span><span class="n">default_field</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">node</span></div>

<div class="viewcode-block" id="NexusFieldHandler.getFrameCount"><a class="viewcode-back" href="../../develop/lavuelib/lavuelib.html#lavuelib.imageFileHandler.NexusFieldHandler.getFrameCount">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getFrameCount</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">growing</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; provides the last frame number</span>

<span class="sd">        :param node: nexus field node</span>
<span class="sd">        :type node: :class:`lavuelib.filewriter.FTField`</span>
<span class="sd">        :param growing: growing dimension</span>
<span class="sd">        :type growing: :obj:`int`</span>
<span class="sd">        :param refresh: refresh image node</span>
<span class="sd">        :type refresh: :obj:`bool`</span>
<span class="sd">        :returns: a number of frames</span>
<span class="sd">        :rtype: :obj:`int`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">refresh</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">node</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">shape</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">growing</span> <span class="ow">and</span> <span class="n">growing</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">shape</span><span class="p">[</span><span class="n">growing</span><span class="p">]</span>
        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="NexusFieldHandler.getMetaData"><a class="viewcode-back" href="../../develop/lavuelib/lavuelib.html#lavuelib.imageFileHandler.NexusFieldHandler.getMetaData">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getMetaData</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">mdata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxrec</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  provides the image metadata</span>

<span class="sd">        :returns: JSON dictionary with image metadata</span>
<span class="sd">        :rtype: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">mdata</span> <span class="k">if</span> <span class="n">mdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">pgroup</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">mnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="s1">&#39;wavelength&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;x_pixel_size&#39;</span><span class="p">,</span> <span class="s1">&#39;y_pixel_size&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;beam_center_x&#39;</span><span class="p">,</span> <span class="s1">&#39;beam_center_y&#39;</span><span class="p">]</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">pgroup</span><span class="o">.</span><span class="n">names</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">mnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">names</span> <span class="ow">and</span> <span class="n">nm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">fld</span> <span class="o">=</span> <span class="n">pgroup</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">fld</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">atts</span> <span class="o">=</span> <span class="p">[</span><span class="n">at</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">fld</span><span class="o">.</span><span class="n">attributes</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s2">&quot;units&quot;</span> <span class="ow">in</span> <span class="n">atts</span><span class="p">:</span>
                        <span class="n">units</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">fld</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">units</span><span class="p">:</span>
                            <span class="n">metadata</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">metadata</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">metadata</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># print(str(e))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">lfld</span> <span class="o">=</span> <span class="n">pgroup</span><span class="o">.</span><span class="n">open_link</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">slpath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">lfld</span><span class="o">.</span><span class="n">target_path</span><span class="p">)</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;:/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">slpath</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">slpath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lpath</span> <span class="o">=</span> <span class="n">slpath</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">lpath</span> <span class="o">=</span> <span class="n">slpath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">opath</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">gr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">gr</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">gr</span> <span class="o">!=</span> <span class="s1">&#39;.&#39;</span><span class="p">])</span>
        <span class="n">lpath</span> <span class="o">=</span> <span class="n">lpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;//&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">lfile</span> <span class="o">=</span> <span class="n">lfld</span><span class="o">.</span><span class="n">getfilename</span><span class="p">(</span><span class="n">lfld</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
           <span class="n">maxrec</span> <span class="ow">and</span> <span class="n">lfile</span> <span class="o">==</span> <span class="n">file_path</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">lpath</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">opath</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">root</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">par</span> <span class="o">=</span> <span class="n">pgroup</span>
                <span class="n">child</span> <span class="o">=</span> <span class="n">node</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">filewriter</span><span class="o">.</span><span class="n">FTFile</span><span class="p">):</span>
                        <span class="n">root</span> <span class="o">=</span> <span class="n">child</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">child</span> <span class="o">=</span> <span class="n">par</span>
                        <span class="n">par</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">parent</span>

                <span class="n">grps</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">lpath</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="n">lnode</span> <span class="o">=</span> <span class="n">root</span>
                <span class="k">for</span> <span class="n">gr</span> <span class="ow">in</span> <span class="n">grps</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">gr</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">lnode</span> <span class="o">=</span> <span class="n">lnode</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">gr</span><span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">getMetaData</span><span class="p">(</span><span class="n">lnode</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">maxrec</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># print(str(e))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span></div>

<div class="viewcode-block" id="NexusFieldHandler.extract"><a class="viewcode-back" href="../../develop/lavuelib/lavuelib.html#lavuelib.imageFileHandler.NexusFieldHandler.extract">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="NexusFieldHandler.getImage"><a class="viewcode-back" href="../../develop/lavuelib/lavuelib.html#lavuelib.imageFileHandler.NexusFieldHandler.getImage">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getImage</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">growing</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;parses the field and add it into the description list</span>

<span class="sd">        :param node: nexus field node</span>
<span class="sd">        :type node: :class:`lavuelib.filewriter.FTField`</span>
<span class="sd">        :param frame: frame to take, the last one is -1</span>
<span class="sd">        :type frame: :obj:`int`</span>
<span class="sd">        :param growing: growing dimension</span>
<span class="sd">        :type growing: :obj:`int`</span>
<span class="sd">        :param refresh: refresh image node</span>
<span class="sd">        :type refresh: :obj:`bool`</span>
<span class="sd">        :returns: get the image</span>
<span class="sd">        :rtype: :class:`numpy.ndarray`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">refresh</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">node</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">shape</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">node</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">growing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">frame</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">frame</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">node</span><span class="p">[</span><span class="n">frame</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="k">elif</span> <span class="n">growing</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">frame</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">frame</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">node</span><span class="p">[:,</span> <span class="n">frame</span><span class="p">,</span> <span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">frame</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">frame</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">node</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">frame</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">growing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">frame</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">frame</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">node</span><span class="p">[</span><span class="n">frame</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="k">elif</span> <span class="n">growing</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">frame</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">frame</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">node</span><span class="p">[:,</span> <span class="n">frame</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="k">elif</span> <span class="n">growing</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">frame</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">frame</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">node</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">frame</span><span class="p">,</span> <span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">frame</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">frame</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">node</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">frame</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="ImageFileHandler"><a class="viewcode-back" href="../../develop/lavuelib/lavuelib.html#lavuelib.imageFileHandler.ImageFileHandler">[docs]</a><span class="k">class</span> <span class="nc">ImageFileHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Simple file handler class.</span>
<span class="sd">       Reads image from file and returns the numpy array.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; constructor</span>

<span class="sd">        :param fname: file name</span>
<span class="sd">        :type fname: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#: (:obj:`any`) module image object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__image</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#: (:obj:`numpy.ndarray`) image data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#: (:obj:`str`) json dictionary with metadata or empty string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">FABIO</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__image</span> <span class="o">=</span> <span class="n">fabio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__image</span><span class="o">.</span><span class="n">data</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no data&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;_array_data.header_convention&quot;</span> \
                   <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__image</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">rmeta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;_array_data.header_contents&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__metadata</span> <span class="o">=</span> <span class="n">CBFLoader</span><span class="p">()</span><span class="o">.</span><span class="n">metadata</span><span class="p">(</span><span class="n">rmeta</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">PILLOW</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__image</span> <span class="o">=</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__image</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">FABIO</span> <span class="ow">and</span> <span class="n">PILLOW</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__image</span> <span class="o">=</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__image</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.cbf&quot;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__data</span> <span class="o">=</span> <span class="n">CBFLoader</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__image</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__metadata</span> <span class="o">=</span> <span class="n">CBFLoader</span><span class="p">()</span><span class="o">.</span><span class="n">metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__image</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__data</span> <span class="o">=</span> <span class="n">TIFLoader</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__image</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># print(str(e))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<div class="viewcode-block" id="ImageFileHandler.getImage"><a class="viewcode-back" href="../../develop/lavuelib/lavuelib.html#lavuelib.imageFileHandler.ImageFileHandler.getImage">[docs]</a>    <span class="k">def</span> <span class="nf">getImage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  provides the image data</span>

<span class="sd">        :returns: image data</span>
<span class="sd">        :rtype: :class:`numpy.ndarray`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data</span></div>

<div class="viewcode-block" id="ImageFileHandler.getMetaData"><a class="viewcode-back" href="../../develop/lavuelib/lavuelib.html#lavuelib.imageFileHandler.ImageFileHandler.getMetaData">[docs]</a>    <span class="k">def</span> <span class="nf">getMetaData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  provides the image metadata</span>

<span class="sd">        :returns: JSON dictionary with image metadata</span>
<span class="sd">        :rtype: :obj:`str`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__metadata</span></div></div>


<div class="viewcode-block" id="CBFLoader"><a class="viewcode-back" href="../../develop/lavuelib/lavuelib.html#lavuelib.imageFileHandler.CBFLoader">[docs]</a><span class="k">class</span> <span class="nc">CBFLoader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; CBF loader &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CBFLoader.metadata"><a class="viewcode-back" href="../../develop/lavuelib/lavuelib.html#lavuelib.imageFileHandler.CBFLoader.metadata">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">flbuffer</span><span class="p">,</span> <span class="n">premeta</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; extract header_contents from CBF file image data</span>

<span class="sd">        :param flbuffer: numpy array with CBF file image data</span>
<span class="sd">        :type flbuffer: :class:`numpy.ndarray` or :obj:`str`</span>
<span class="sd">        :param premeta: metadata to be merged</span>
<span class="sd">        :type premeta: :obj:`dict`  &lt;:obj:`str`, :obj:`any`&gt;</span>
<span class="sd">        :returns: metadata dictionary</span>
<span class="sd">        :rtype: :class:`numpy.ndarray`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">headerstart</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;_array_data.header_convention&#39;</span>
        <span class="n">headerend</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;_array_data.data&#39;</span>
        <span class="n">mdata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">flbuffer</span><span class="p">,</span> <span class="s2">&quot;tostring&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hspos</span> <span class="o">=</span> <span class="n">flbuffer</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">headerstart</span><span class="p">)</span> <span class="o">//</span> \
                        <span class="n">flbuffer</span><span class="o">.</span><span class="n">itemsize</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">hspos</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">hepos</span> <span class="o">=</span> <span class="n">flbuffer</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">headerend</span><span class="p">)</span> <span class="o">//</span> \
                    <span class="n">flbuffer</span><span class="o">.</span><span class="n">itemsize</span>
                <span class="n">flbuffer</span> <span class="o">=</span> <span class="n">flbuffer</span><span class="p">[</span><span class="n">hspos</span><span class="p">:</span><span class="n">hepos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># print(str(e))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">flbuffer</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">flbuffer</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">sheader</span> <span class="o">=</span> <span class="p">[</span><span class="n">hd</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">hd</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
                   <span class="k">if</span> <span class="n">hd</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;# &quot;</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">sheader</span> <span class="ow">and</span> <span class="n">sheader</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Detector: &quot;</span><span class="p">):</span>
            <span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;detector&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sheader</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">if</span> <span class="n">sheader</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sheader</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sheader</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">hd</span> <span class="ow">in</span> <span class="n">sheader</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">hd</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Silicon sensor, thickness &quot;</span><span class="p">):</span>
                    <span class="n">dt</span> <span class="o">=</span> <span class="n">hd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">3</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="n">dt</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;silicon_sensor_thickness&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dt</span> <span class="o">=</span> <span class="n">hd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">dt</span><span class="p">:</span>
                        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="n">dt</span> <span class="ow">and</span> <span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
                        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="n">dt</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">dt</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">])][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">dt</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="n">dt</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">elif</span> <span class="n">dt</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">dt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                    <span class="n">dt</span> <span class="o">=</span> <span class="p">[(</span><span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dt</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dt</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">dt</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
                                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                        <span class="k">pass</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">dt</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;(), &quot;</span><span class="p">)),</span> <span class="n">dt</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                                      <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;(), &quot;</span><span class="p">)),</span> <span class="n">dt</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                    <span class="k">elif</span> <span class="n">dt</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">dt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">dt</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                      <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">dt</span><span class="p">[</span><span class="mi">4</span><span class="p">])]</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="k">pass</span>
                        <span class="k">elif</span> <span class="n">dt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">dt</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                      <span class="p">{</span><span class="n">dt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;(), &quot;</span><span class="p">):</span>
                                       <span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;(), &quot;</span><span class="p">))}]</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="k">pass</span>

                    <span class="n">mdata</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># print(str(e))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">mdata</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">premeta</span><span class="p">:</span>
                <span class="n">mdata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">premeta</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">mdata</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">premeta</span><span class="p">)</span> <span class="k">if</span> <span class="n">premeta</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span></div>

<div class="viewcode-block" id="CBFLoader.load"><a class="viewcode-back" href="../../develop/lavuelib/lavuelib.html#lavuelib.imageFileHandler.CBFLoader.load">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">flbuffer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; loads CBF file image data into numpy array</span>

<span class="sd">        :param flbuffer: numpy array with CBF file image data</span>
<span class="sd">        :type flbuffer: :class:`numpy.ndarray`</span>
<span class="sd">        :returns: image data</span>
<span class="sd">        :rtype: :class:`numpy.ndarray`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">inpoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">26</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">213</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>

        <span class="c1"># array with &#39;--CIF-BINARY-FORMAT-SECTION---&#39;</span>
        <span class="n">outpoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span>
             <span class="mi">79</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># check if byte offset compress (&#39;x-CBF_BYTE_OFFSET&#39;)</span>
        <span class="n">boc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">120</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span>
             <span class="mi">69</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">84</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># iscbf</span>
            <span class="n">flbuffer</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">boc</span><span class="o">.</span><span class="n">tostring</span><span class="p">())</span> <span class="o">//</span> <span class="n">flbuffer</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># additional parms for cross check if decompress worked out</span>
        <span class="c1"># (&#39;X-Binary-Number-of-Elements:&#39;)</span>
        <span class="n">dset_num_ele</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">88</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span>
             <span class="mi">101</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span>
             <span class="mi">116</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">58</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
        <span class="c1"># array with &#39;X-Binary-Size-Fastest-Dimension:&#39;</span>
        <span class="n">dset_fast_dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">88</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span>
             <span class="mi">97</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span>
             <span class="mi">111</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">58</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
        <span class="c1"># array with &#39;X-Binary-Size-Second-Dimension:&#39;</span>
        <span class="n">dset_sec_dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">88</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span>
             <span class="mi">101</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span>
             <span class="mi">110</span><span class="p">,</span> <span class="mi">58</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
        <span class="c1"># array with &#39;X-Binary-Size-Padding:&#39;</span>
        <span class="n">dset_pad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">88</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span>
             <span class="mi">97</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">58</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>

        <span class="c1"># search for data stream start</span>
        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">idstart</span> <span class="o">=</span> <span class="n">flbuffer</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                    <span class="n">inpoint</span><span class="o">.</span><span class="n">tostring</span><span class="p">())</span> <span class="o">//</span> <span class="n">flbuffer</span><span class="o">.</span><span class="n">itemsize</span>
                <span class="n">idstart</span> <span class="o">+=</span> <span class="n">inpoint</span><span class="o">.</span><span class="n">size</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">idstop</span> <span class="o">=</span> <span class="n">flbuffer</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                    <span class="n">outpoint</span><span class="o">.</span><span class="n">tostring</span><span class="p">())</span> <span class="o">//</span> <span class="n">flbuffer</span><span class="o">.</span><span class="n">itemsize</span>
                <span class="n">idstop</span> <span class="o">-=</span> <span class="mi">3</span>  <span class="c1"># cr / extra -1 due to &#39;10B&#39; -- linefeed</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
            <span class="n">spos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
            <span class="n">spos</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">idstart</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">spos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">flbuffer</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                    <span class="n">dset_num_ele</span><span class="o">.</span><span class="n">tostring</span><span class="p">())</span> <span class="o">//</span> <span class="n">flbuffer</span><span class="o">.</span><span class="n">itemsize</span>
                <span class="n">spos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">flbuffer</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                    <span class="n">dset_fast_dim</span><span class="o">.</span><span class="n">tostring</span><span class="p">())</span> <span class="o">//</span> <span class="n">flbuffer</span><span class="o">.</span><span class="n">itemsize</span>
                <span class="n">spos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">flbuffer</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                    <span class="n">dset_sec_dim</span><span class="o">.</span><span class="n">tostring</span><span class="p">())</span> <span class="o">//</span> <span class="n">flbuffer</span><span class="o">.</span><span class="n">itemsize</span>
                <span class="n">spos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">flbuffer</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                    <span class="n">dset_pad</span><span class="o">.</span><span class="n">tostring</span><span class="p">())</span> <span class="o">//</span> <span class="n">flbuffer</span><span class="o">.</span><span class="n">itemsize</span>
<span class="c1"># by A.R., Apr 24, 2017</span>
                <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="n">flbuffer</span><span class="p">[</span>
                        <span class="n">spos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dset_num_ele</span><span class="o">.</span><span class="n">size</span><span class="p">:</span><span class="n">spos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tostring</span><span class="p">())</span>
                <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="n">flbuffer</span><span class="p">[</span>
                        <span class="n">spos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dset_fast_dim</span><span class="o">.</span><span class="n">size</span><span class="p">:</span><span class="n">spos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tostring</span><span class="p">())</span>
                <span class="n">vals</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="n">flbuffer</span><span class="p">[</span>
                        <span class="n">spos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">dset_sec_dim</span><span class="o">.</span><span class="n">size</span><span class="p">:</span><span class="n">spos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tostring</span><span class="p">())</span>
                <span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="n">flbuffer</span><span class="p">[</span>
                        <span class="n">spos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">dset_pad</span><span class="o">.</span><span class="n">size</span><span class="p">:</span><span class="n">spos</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">tostring</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">image</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_decompress_cbf_c</span><span class="p">(</span>
                    <span class="n">flbuffer</span><span class="p">[</span><span class="n">idstart</span><span class="p">:</span><span class="n">idstop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">vals</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_decompress_cbf_c</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; decompresses CBF</span>

<span class="sd">        :param stream: a part of cbf data</span>
<span class="sd">        :type stream: :class:`numpy.ndarray`</span>
<span class="sd">        :param val: decompress parameters, i.e. n_out, xdim, ydum padding</span>
<span class="sd">        :type val: :class:`numpy.ndarray`</span>
<span class="sd">        :returns: image data</span>
<span class="sd">        :rtype: :class:`numpy.ndarray`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xdim</span> <span class="o">=</span> <span class="n">long</span><span class="p">(</span><span class="mi">487</span><span class="p">)</span>
        <span class="n">ydim</span> <span class="o">=</span> <span class="mi">619</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="n">long</span><span class="p">(</span><span class="mi">4095</span><span class="p">)</span>
        <span class="n">n_out</span> <span class="o">=</span> <span class="n">xdim</span> <span class="o">*</span> <span class="n">ydim</span>

        <span class="c1"># simply assume content fits here</span>
        <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="nb">sum</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">xdim</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ydim</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">n_out</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">flbuffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">stream</span>
        <span class="n">mymap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">isvalid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">id_relevant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stream</span> <span class="o">==</span> <span class="mi">128</span><span class="p">)</span>

        <span class="c1"># overcome issue if 128 exists in padding (seems so that</span>
        <span class="c1"># either this does not happened before or padding was 0 in any case)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">idd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">id_relevant</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">flbuffer</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">padding</span><span class="p">))</span>
            <span class="n">id_relevant</span> <span class="o">=</span> <span class="n">id_relevant</span><span class="p">[</span><span class="n">idd</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">for</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">id_relevant</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dummy2</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">mymap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">stream</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">stream</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">128</span><span class="p">:</span>
                        <span class="n">mymap</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">isvalid</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">delta</span> <span class="o">=</span> <span class="n">flbuffer</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">flbuffer</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span>
                        <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">32768</span><span class="p">:</span>
                            <span class="n">delta</span> <span class="o">-=</span> <span class="mi">65536</span>
                        <span class="n">flbuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mymap</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">isvalid</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="c1"># delta=sum(np.multiply(flbuffer[i+3:i+7],</span>
                        <span class="c1">#   np.array([1,256,65536,16777216],dtype=&#39;int64&#39;)))</span>
                        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                                <span class="n">flbuffer</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">],</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">65536</span><span class="p">,</span> <span class="mi">16777216</span><span class="p">],</span>
                                         <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">2147483648</span><span class="p">:</span>
                            <span class="n">delta</span> <span class="o">-=</span> <span class="mi">4294967296</span>
                        <span class="n">flbuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">id8sign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">stream</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mymap</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">flbuffer</span><span class="p">[</span><span class="n">id8sign</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">256</span>
            <span class="c1"># print (&quot;adjusting 8Bit vals&quot;)</span>
            <span class="c1"># for i, j in enumerate(stream):</span>
            <span class="c1">#     if j &gt; 128 and mymap[i] !=0:</span>
            <span class="c1">#         flbuffer[i]=flbuffer[i]-256</span>
            <span class="c1"># print stream[0:11]</span>
            <span class="c1"># print flbuffer[0:11]</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># print sum(isvalid)    #should be 305548</span>
            <span class="n">idd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">isvalid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">flbuffer</span> <span class="o">=</span> <span class="n">flbuffer</span><span class="p">[</span><span class="n">idd</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># print stream[0:11]</span>
        <span class="c1"># print flbuffer[0:11]</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">flbuffer</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
        <span class="c1"># print max(res)</span>

        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">padding</span> <span class="o">!=</span> <span class="n">n_out</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># by A.R., Apr 24, 2017</span>
        <span class="c1"># return res[0:n_out].reshape(xdim, ydim)</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n_out</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TIFLoader"><a class="viewcode-back" href="../../develop/lavuelib/lavuelib.html#lavuelib.imageFileHandler.TIFLoader">[docs]</a><span class="k">class</span> <span class="nc">TIFLoader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; TIF loader &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TIFLoader.load"><a class="viewcode-back" href="../../develop/lavuelib/lavuelib.html#lavuelib.imageFileHandler.TIFLoader.load">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">flbuffer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; loads TIF file image data into numpy array</span>

<span class="sd">        :param flbuffer: numpy array with TIF file image data</span>
<span class="sd">        :type flbuffer: :class:`numpy.ndarray`</span>
<span class="sd">        :returns: image data</span>
<span class="sd">        :rtype: :class:`numpy.ndarray`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># define unsigned default if undefined - i.e. like MAR165 data</span>
        <span class="n">sample_format</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">flbuffer_endian</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">flbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="p">[</span><span class="mi">73</span><span class="p">,</span> <span class="mi">73</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">flbuffer_endian</span> <span class="o">=</span> <span class="s2">&quot;&lt;&quot;</span>  <span class="c1"># little</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">flbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="p">[</span><span class="mi">77</span><span class="p">,</span> <span class="mi">77</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">flbuffer_endian</span> <span class="o">=</span> <span class="s2">&quot;&gt;&quot;</span>  <span class="c1"># big</span>

        <span class="k">if</span> <span class="n">flbuffer_endian</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">image</span>     <span class="c1"># or better to raise exception?</span>

        <span class="n">numfortiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">(</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="n">flbuffer_endian</span> <span class="o">+</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="n">flbuffer</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">numfortiff</span> <span class="o">!=</span> <span class="mi">42</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">image</span>  <span class="c1"># or better to raise exception?</span>

        <span class="n">ifd_off</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">(</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="n">flbuffer_endian</span> <span class="o">+</span> <span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="n">flbuffer</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1">#</span>
        <span class="c1"># jump to/eval image file directory (ifd)</span>
        <span class="n">num_of_ifd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">(</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span>
                <span class="n">flbuffer_endian</span> <span class="o">+</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="n">flbuffer</span><span class="p">[</span><span class="n">ifd_off</span><span class="p">:</span><span class="n">ifd_off</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">ifd_entry</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_of_ifd</span><span class="p">):</span>
            <span class="n">field_tag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">(</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span>
                    <span class="n">flbuffer_endian</span> <span class="o">+</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span>
                    <span class="n">flbuffer</span><span class="p">[</span><span class="n">ifd_off</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ifd_entry</span> <span class="o">*</span> <span class="mi">12</span><span class="p">:</span><span class="n">ifd_off</span>
                             <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">ifd_entry</span> <span class="o">*</span> <span class="mi">12</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">field_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">(</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span>
                    <span class="n">flbuffer_endian</span> <span class="o">+</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span>
                    <span class="n">flbuffer</span><span class="p">[</span><span class="n">ifd_off</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">ifd_entry</span> <span class="o">*</span> <span class="mi">12</span><span class="p">:</span><span class="n">ifd_off</span>
                             <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">ifd_entry</span> <span class="o">*</span> <span class="mi">12</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># num_vals = np.uint32(</span>
            <span class="c1">#    struct.unpack_from(</span>
            <span class="c1">#        flbuffer_endian + &quot;I&quot;,</span>
            <span class="c1">#        flbuffer[ifd_off + 6 + ifd_entry * 12:ifd_off + 10</span>
            <span class="c1">#                 + ifd_entry * 12])[0])</span>
            <span class="c1"># given tiff 6.0 there are 12 type entries, currently not all of</span>
            <span class="c1"># them are accounted, A.R.</span>
            <span class="n">val_or_off</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">field_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># check flbuffer addressing!</span>
                <span class="n">val_or_off</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span>
                        <span class="n">flbuffer_endian</span> <span class="o">+</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span>
                        <span class="n">flbuffer</span><span class="p">[</span><span class="n">ifd_off</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">ifd_entry</span> <span class="o">*</span> <span class="mi">12</span><span class="p">:</span><span class="n">ifd_off</span> <span class="o">+</span> <span class="mi">15</span>
                                 <span class="o">+</span> <span class="n">ifd_entry</span> <span class="o">*</span> <span class="mi">12</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">field_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">val_or_off</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">(</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span>
                        <span class="n">flbuffer_endian</span> <span class="o">+</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span>
                        <span class="n">flbuffer</span><span class="p">[</span><span class="n">ifd_off</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">ifd_entry</span> <span class="o">*</span> <span class="mi">12</span><span class="p">:</span><span class="n">ifd_off</span> <span class="o">+</span> <span class="mi">15</span>
                                 <span class="o">+</span> <span class="n">ifd_entry</span> <span class="o">*</span> <span class="mi">12</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">field_type</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">val_or_off</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">(</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span>
                        <span class="n">flbuffer_endian</span> <span class="o">+</span> <span class="s2">&quot;I&quot;</span><span class="p">,</span>
                        <span class="n">flbuffer</span><span class="p">[</span><span class="n">ifd_off</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">ifd_entry</span> <span class="o">*</span> <span class="mi">12</span><span class="p">:</span><span class="n">ifd_off</span> <span class="o">+</span> <span class="mi">15</span>
                                 <span class="o">+</span> <span class="n">ifd_entry</span> <span class="o">*</span> <span class="mi">12</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">field_type</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">val_or_off</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">(</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span>
                        <span class="n">flbuffer_endian</span> <span class="o">+</span> <span class="s2">&quot;h&quot;</span><span class="p">,</span>
                        <span class="n">flbuffer</span><span class="p">[</span><span class="n">ifd_off</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">ifd_entry</span> <span class="o">*</span> <span class="mi">12</span><span class="p">:</span><span class="n">ifd_off</span>
                                 <span class="o">+</span> <span class="mi">15</span> <span class="o">+</span> <span class="n">ifd_entry</span> <span class="o">*</span> <span class="mi">12</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">field_type</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                <span class="n">val_or_off</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span>
                        <span class="n">flbuffer_endian</span> <span class="o">+</span> <span class="s2">&quot;i&quot;</span><span class="p">,</span>
                        <span class="n">flbuffer</span><span class="p">[</span><span class="n">ifd_off</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">ifd_entry</span> <span class="o">*</span> <span class="mi">12</span><span class="p">:</span><span class="n">ifd_off</span> <span class="o">+</span> <span class="mi">15</span>
                                 <span class="o">+</span> <span class="n">ifd_entry</span> <span class="o">*</span> <span class="mi">12</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">field_type</span> <span class="o">==</span> <span class="mi">11</span><span class="p">:</span>
                <span class="n">val_or_off</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span>
                        <span class="n">flbuffer_endian</span> <span class="o">+</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span>
                        <span class="n">flbuffer</span><span class="p">[</span><span class="n">ifd_off</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">ifd_entry</span> <span class="o">*</span> <span class="mi">12</span><span class="p">:</span><span class="n">ifd_off</span>
                                 <span class="o">+</span> <span class="mi">15</span> <span class="o">+</span> <span class="n">ifd_entry</span> <span class="o">*</span> <span class="mi">12</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># eval (hopefully) tags needed to allow for getting an image</span>
            <span class="k">if</span> <span class="n">field_tag</span> <span class="o">==</span> <span class="mi">256</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val_or_off</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field_tag</span> <span class="o">==</span> <span class="mi">257</span><span class="p">:</span>
                <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val_or_off</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field_tag</span> <span class="o">==</span> <span class="mi">258</span><span class="p">:</span>
                <span class="n">bit_per_sample</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val_or_off</span><span class="p">)</span>
            <span class="c1"># compression scheme - return invalid if NOT none,</span>
            <span class="c1"># i.e. only uncompressed data is supported (forever!?)</span>
            <span class="k">if</span> <span class="n">field_tag</span> <span class="o">==</span> <span class="mi">259</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val_or_off</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">image</span>
            <span class="c1"># photometric interpretation - 2 denotes RGB which is refused</span>
            <span class="c1"># otherwise don&#39;t mind/care ...</span>
            <span class="k">if</span> <span class="n">field_tag</span> <span class="o">==</span> <span class="mi">262</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val_or_off</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">image</span>
            <span class="k">if</span> <span class="n">field_tag</span> <span class="o">==</span> <span class="mi">273</span><span class="p">:</span>
                <span class="n">strip_offsets</span> <span class="o">=</span> <span class="n">val_or_off</span>
            <span class="c1"># likely equals image width</span>
            <span class="c1"># if field_tag == 278:</span>
            <span class="c1">#    rows_per_strip = val_or_off</span>
            <span class="k">if</span> <span class="n">field_tag</span> <span class="o">==</span> <span class="mi">279</span><span class="p">:</span>
                <span class="n">strip_byte_counts</span> <span class="o">=</span> <span class="n">val_or_off</span>
            <span class="k">if</span> <span class="n">field_tag</span> <span class="o">==</span> <span class="mi">339</span><span class="p">:</span>
                <span class="n">sample_format</span> <span class="o">=</span> <span class="n">val_or_off</span>

        <span class="n">next_idf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">(</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span>
                <span class="n">flbuffer_endian</span> <span class="o">+</span> <span class="s2">&quot;I&quot;</span><span class="p">,</span>
                <span class="n">flbuffer</span><span class="p">[</span><span class="n">ifd_off</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">ifd_entry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">12</span><span class="p">:</span>
                         <span class="n">ifd_off</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="n">ifd_entry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">12</span><span class="p">]</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">next_idf</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># print(&#39;another ifd exists ... NOT read&#39;)</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">width</span> <span class="o">*</span> <span class="n">length</span> <span class="o">*</span> <span class="n">bit_per_sample</span> <span class="o">//</span> <span class="mi">8</span> <span class="o">!=</span> <span class="n">strip_byte_counts</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">image</span>

        <span class="k">if</span> <span class="n">sample_format</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">bit_per_sample</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span>
                    <span class="n">flbuffer_endian</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span>
                    <span class="n">flbuffer</span><span class="p">[</span><span class="n">strip_offsets</span><span class="p">:</span><span class="n">strip_offsets</span>
                             <span class="o">+</span> <span class="n">strip_byte_counts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">sample_format</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">bit_per_sample</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">(</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span>
                    <span class="n">flbuffer_endian</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span>
                    <span class="n">flbuffer</span><span class="p">[</span><span class="n">strip_offsets</span><span class="p">:</span><span class="n">strip_offsets</span>
                             <span class="o">+</span> <span class="n">strip_byte_counts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">sample_format</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">bit_per_sample</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">(</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span>
                    <span class="n">flbuffer_endian</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;I&quot;</span><span class="p">,</span>
                    <span class="n">flbuffer</span><span class="p">[</span><span class="n">strip_offsets</span><span class="p">:</span><span class="n">strip_offsets</span>
                             <span class="o">+</span> <span class="n">strip_byte_counts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="c1"># if sample_format == 2 and bit_per_sample == 8:</span>
        <span class="c1">#     image=np.int8(struct.unpack_from(</span>
        <span class="c1">#           flbuffer_endian+str(width*length)+&quot;b&quot;,</span>
        <span class="c1">#     flbuffer[strip_offsets:strip_offsets</span>
        <span class="c1">#              +strip_byte_counts+1]))</span>
        <span class="k">if</span> <span class="n">sample_format</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">bit_per_sample</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">(</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span>
                    <span class="n">flbuffer_endian</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;h&quot;</span><span class="p">,</span>
                    <span class="n">flbuffer</span><span class="p">[</span><span class="n">strip_offsets</span><span class="p">:</span><span class="n">strip_offsets</span>
                             <span class="o">+</span> <span class="n">strip_byte_counts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">sample_format</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">bit_per_sample</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span>
                    <span class="n">flbuffer_endian</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;i&quot;</span><span class="p">,</span>
                    <span class="n">flbuffer</span><span class="p">[</span><span class="n">strip_offsets</span><span class="p">:</span><span class="n">strip_offsets</span>
                             <span class="o">+</span> <span class="n">strip_byte_counts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">sample_format</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">bit_per_sample</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span>
                    <span class="n">flbuffer_endian</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span>
                    <span class="n">flbuffer</span><span class="p">[</span><span class="n">strip_offsets</span><span class="p">:</span><span class="n">strip_offsets</span>
                             <span class="o">+</span> <span class="n">strip_byte_counts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image</span><span class="p">)</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="c1"># filename =</span>
    <span class="c1"># &#39;/afs/desy.de/user/r/rothkirc/public/P03/lost_00001_00001.tif&#39; # input</span>
    <span class="c1"># file name</span>
    <span class="c1"># input file name</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;/afs/desy.de/user/r/rothkirc/public/20131129_eugen/&#39;</span> \
               <span class="o">+</span> <span class="s1">&#39;mar165_agbeh_00001.tif&#39;</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>  <span class="c1"># read all content as unit 8</span>
    <span class="n">resu</span> <span class="o">=</span> <span class="n">TIFLoader</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Return value shape and dtype&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resu</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">resu</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">LaVue 2.83.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">lavuelib.imageFileHandler</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017 DESY, Jan Kotanski &lt;jkotan@mail.desy.de&gt;, Christoph Rosemann &lt;christoph.rosemann@desy.de&gt; 

GNU GENERAL PUBLIC LICENSE, version 2.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.3.2.
    </div>
  </body>
</html>